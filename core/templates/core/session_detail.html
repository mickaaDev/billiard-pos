<style>
    /* Targeting only the minutes input by ID */
    #extra_minutes::-webkit-outer-spin-button,
    #extra_minutes::-webkit-inner-spin-button {
        -webkit-appearance: none;
        margin: 0;
    }

    #extra_minutes[type=number] {
        -moz-appearance: textfield;
    }
</style>
{% extends "core/base.html" %}

{% block content %}
<div style="display: flex; gap: 20px; font-family: sans-serif; max-width: 1000px; margin: auto;">
    
    <div style="flex: 2; border: 1px solid #ddd; border-radius: 8px; padding: 20px; background: #fff;">
        <div style="display: flex; justify-content: space-between; align-items: center; border-bottom: 2px solid #eee; padding-bottom: 10px;">
            <h2 style="margin: 0;">–°–µ—Å—Å–∏—è #{{ session.id }}</h2>
            <span style="background: #d9534f; color: white; padding: 4px 8px; border-radius: 4px; font-size: 0.8em;">LIVE</span>
        </div>

        <div style="margin-top: 20px;">
            <p><strong>–†–µ—Å—É—Ä—Å:</strong> {{ session.resource.name }} ({{ session.resource.price_per_hour }}/—á–∞—Å)</p>
            <p><strong>–ù–∞—á–∞—Ç–æ:</strong> {{ session.start_time|date:"H:i" }}</p>
            <p><strong>–ü–µ—Ä—Å–æ–Ω–∞–ª:</strong> {{ session.created_by.username }}</p>
        </div>
        <div id="timer-banner" style="margin-bottom: 20px; padding: 15px; background: {% if is_expired %}#f8d7da{% else %}#eef2f7{% endif %}; border-radius: 8px; transition: background 0.5s;">
    <strong id="timer-label">
        {% if session.mode == 'PREPAID' %}–û—Å—Ç–∞–≤—à–µ–µ—Å—è –≤—Ä–µ–º—è:{% else %}–ü—Ä–æ—à–µ–¥—à–µ–µ –≤—Ä–µ–º—è:{% endif %}
    </strong> 
    <span id="live-counter" style="font-family: monospace; font-size: 1.2em; font-weight: bold; color: {% if is_expired %}#d9534f{% else %}#007bff{% endif %};">
        –†–∞—Å—á–µ—Ç...
    </span>
    
    {% if session.mode == 'PREPAID' %}
        <small style="display:block; color: #666; margin-bottom: 10px;">–õ–∏–º–∏—Ç: {{ session.prepaid_minutes }} –º–∏–Ω</small>

        <div style="margin-top: 15px; padding-top: 10px; border-top: 1px solid rgba(0,0,0,0.1);">
    <form action="{% url 'core:extend_session' session.pk %}" method="post">
        {% csrf_token %}
        <div style="display: flex; gap: 8px; align-items: flex-end;">
            <div style="flex: 1;">
                <small style=" display: block; font-size: 0.75em; color: #555; margin-bottom: 4px;">–°—É–º–º–∞ (—Å–æ–º):</small>
                <input type="number" id="extend_amount" placeholder="–ù–∞–ø—Ä: 200" 
                       style="width: 90%; padding: 8px; border-radius: 4px; border: 1px solid #ccc; font-size: 0.9em;"
                       oninput="calculateExtensionTime()">
            </div>
            <div style="flex: 1;">
                <small style="display: block; font-size: 0.75em; color: #555; margin-bottom: 4px;">+ –ú–∏–Ω—É—Ç—ã:</small>
                <input type="number" name="extra_minutes" id="extra_minutes" placeholder="--" readonly
                       style="width: 90%; padding: 8px; border-radius: 4px; border: 1px solid #ccc; font-size: 0.9em; background-color: #f0f0f0; color: #555; cursor: not-allowed;">
            </div>
            <button type="submit" style="background: #28a745; color: white; border: none; padding: 9px 15px; border-radius: 4px; font-weight: bold; cursor: pointer; font-size: 0.85em;">
                –ü–†–û–î–õ–ò–¢–¨
            </button>
        </div>
    </form>
</div>
    {% endif %}
</div>

<script>
    function calculateExtensionTime() {
    const pricePerHour = parseFloat("{{ session.resource.price_per_hour }}");
    const amount = parseFloat(document.getElementById('extend_amount').value);
    const minutesInput = document.getElementById('extra_minutes');
    
    if (!isNaN(amount) && amount > 0) {
        // (Amount / Hourly Price) * 60 minutes
        let extraMins = (amount / pricePerHour) * 60;
        minutesInput.value = Math.floor(extraMins);
    } else {
        minutesInput.value = '';
    }
}
    const startTime = new Date("{{ session.start_time|date:'c' }}");
    const mode = "{{ session.mode }}";
    const prepaidLimitMs = {{ session.prepaid_minutes|default:0 }} * 60 * 1000;

    function updateCounter() {
        // ... (your existing updateCounter logic) ...
        const now = new Date();
        const elapsedMs = Math.max(0, now - startTime);
        
        let displaySeconds;
        let isOverTime = false;

        if (mode === 'PREPAID') {
            const remainingMs = prepaidLimitMs - elapsedMs;
            if (remainingMs <= 0) {
                displaySeconds = Math.floor(Math.abs(remainingMs) / 1000);
                isOverTime = true;
            } else {
                displaySeconds = Math.floor(remainingMs / 1000);
            }
        } else {
            displaySeconds = Math.floor(elapsedMs / 1000);
        }

        const hours = Math.floor(displaySeconds / 3600);
        const minutes = Math.floor((displaySeconds % 3600) / 60);
        const seconds = displaySeconds % 60;

        const display = 
            (hours < 10 ? "0" + hours : hours) + ":" + 
            (minutes < 10 ? "0" + minutes : minutes) + ":" + 
            (seconds < 10 ? "0" + seconds : seconds);

        const counterElement = document.getElementById('live-counter');
        const banner = document.getElementById('timer-banner');
        const label = document.getElementById('timer-label');

        if (counterElement) {
            counterElement.innerText = (isOverTime ? "-" : "") + display;
            if (isOverTime && mode === 'PREPAID') {
                banner.style.background = "#f8d7da";
                counterElement.style.color = "#d9534f";
                label.innerText = "–í–†–ï–ú–Ø –ò–°–¢–ï–ö–õ–û:";
            }
        }
    }

    setInterval(updateCounter, 1000);
    updateCounter();

    // --- ADD THIS PART BELOW ---
    // Refresh page every 30 seconds to update the money/billing numbers from the server
    setTimeout(function(){
       window.location.reload();
    }, 60000); 
</script>
        <table style="width: 100%; border-collapse: collapse; margin-top: 20px;">
            <tr style="background: #f8f9fa;">
                <th style="text-align: left; padding: 10px; border-bottom: 2px solid #ddd;">–û–ø–∏—Å–∞–Ω–∏–µ</th>
                <th style="text-align: right; padding: 10px; border-bottom: 2px solid #ddd;">–û–±—â–∏–π</th>
            </tr>
            <tr>
                <td style="padding: 10px; border-bottom: 1px solid #eee;">
    –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –≤—Ä–µ–º–µ–Ω–∏ (<span id="duration-display">{{ duration_minutes }}</span> –º–∏–Ω—É—Ç—ã)
</td>
                <td id="time-cost-1" style="text-align: right; padding: 10px; border-bottom: 1px solid #eee;">
    {{ time_cost }} —Å–æ–º
</td>
            </tr>
            </table>
            <div style="background: white; border-radius: 12px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); overflow: hidden; border: 1px solid #eee;">
    <table style="width: 100%; border-collapse: collapse; text-align: left;">
        <thead>
            <tr style="background: #f8f9fa; border-bottom: 2px solid #eee;">
                <th style="padding: 15px; color: #666; font-size: 0.85em; text-transform: uppercase;">–û–ø–∏—Å–∞–Ω–∏–µ —Ç–æ–≤–∞—Ä–∞</th>
                <th style="padding: 15px; color: #666; font-size: 0.85em; text-transform: uppercase; text-align: right;">–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ</th>
            </tr>
        </thead>
        <tbody>
            <tr style="border-bottom: 1px solid #eee;">
                <td style="padding: 15px;">
                    <div style="font-weight: bold; color: #2c3e50;">–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –≤—Ä–µ–º–µ–Ω–∏</div>
                    <small style="color: #999;">{{ session.resource.price_per_hour }}/—á–∞—Å</small>
                </td>
                <td id="time-cost-2" style="padding: 15px; text-align: right; font-weight: bold; color: #2c3e50;">
    {{ time_cost }} —Å–æ–º
</td>

            {% for item in session_items %}
<tr style="border-bottom: 1px solid #eee;">
    <td style="padding: 15px;">
        <div style="font-weight: bold; color: #2c3e50;">{{ item.product.name }}</div>
        <small style="color: #999;">{{ item.price_at_order }} —Å–æ–º –∑–∞ –µ–¥–∏–Ω–∏—Ü—É</small>
    </td>
    <td style="padding: 15px; text-align: right; font-weight: bold; color: #2c3e50;">
        <div style="display: flex; align-items: center; justify-content: flex-end; gap: 10px;">
            <span style="background: #e9ecef; padding: 2px 8px; border-radius: 4px; font-size: 0.9em;">
                x{{ item.quantity }}
            </span>
            <span style="margin-right: 10px;">{{ item.total_price }} —Å–æ–º</span>
            
            <form action="{% url 'core:remove_item_from_session' item.id %}" method="post" style="margin: 0;">
                {% csrf_token %}
                <button type="submit" 
                        onclick="return confirm('–£–¥–∞–ª–∏—Ç—å {{ item.product.name }}?')"
                        style="background: #ff4d4d; color: white; border: none; border-radius: 4px; width: 24px; height: 24px; cursor: pointer; font-size: 14px; line-height: 1; display: flex; align-items: center; justify-content: center; transition: 0.2s;"
                        title="–£–¥–∞–ª–∏—Ç—å —Ç–æ–≤–∞—Ä">
                    &times;
                </button>
            </form>
        </div>
    </td>
</tr>
{% endfor %}
        </tbody>
    </table>

    <div style="background: #2c3e50; color: white; padding: 20px; display: flex; justify-content: space-between; align-items: center;">
        <span style="font-size: 1.1em; text-transform: uppercase; letter-spacing: 1px;">–û–±—â–∏–π –∏—Ç–æ–≥</span>
        <span id="grand-total-display" style="font-size: 1.8em; font-weight: bold;">
    {{ grand_total }} —Å–æ–º
</span>
    </div>
</div>
        <div style="text-align: right; margin-top: 20px; font-size: 1.5em; font-weight: bold;">
            –û–±—â–∏–π: —Å–æ–º {{ time_cost }}
        </div>

        <div style="margin-top: 30px; display: flex; align-items: center; gap: 15px;">
    
    <form action="{% url 'core:close_session' session.id %}" method="post" style="flex: 2; margin: 0;">
    {% csrf_token %}

    {% if overtime_minutes > 0 %}
    <div id="overtime-banner" style="background: #fff3cd; border: 1px solid #ffeeba; padding: 12px; border-radius: 8px; margin-bottom: 12px; display: flex; align-items: center; gap: 12px; border-left: 5px solid #ffc107;">
        <input type="checkbox" id="charge_overtime" name="charge_overtime" value="true" 
               style="width: 22px; height: 22px; cursor: pointer; accent-color: #856404;">
        
        <label for="charge_overtime" style="font-size: 0.9em; color: #856404; cursor: pointer; line-height: 1.2;">
            <strong>–î–æ–±–∞–≤–∏—Ç—å –ø–µ—Ä–µ—Ä–∞–±–æ—Ç–∫—É?</strong><br>
            –í–∫–ª—é—á–∏—Ç—å {{ overtime_minutes }} –º–∏–Ω. –≤ —Å—á–µ—Ç
        </label>
    </div>
    {% endif %}

    <button type="submit" 
            onclick="return confirm('‚ö†Ô∏è –í–´ –£–í–ï–†–ï–ù–´?\n\n–≠—Ç–æ –æ—Å—Ç–∞–Ω–æ–≤–∏—Ç —Ç–∞–π–º–µ—Ä –∏ —Å—Ñ–æ—Ä–º–∏—Ä—É–µ—Ç –∏—Ç–æ–≥–æ–≤—ã–π —á–µ–∫.')" 
            style="height: 50px; width: 100%; background: #dc3545; color: #fff; border: none; border-radius: 6px; font-weight: bold; cursor: pointer; font-size: 0.9em; transition: 0.2s;">
        –ó–ê–í–ï–†–®–ò–¢–¨ –ò –ó–ê–ö–†–´–¢–¨ –°–ï–ê–ù–°
    </button>
</form>
    
    <a href="{% url 'core:dashboard' %}" 
       style="flex: 1; height: 50px; line-height: 50px; background: #6c757d; color: white; border-radius: 6px; text-decoration: none; text-align: center; font-weight: bold; font-size: 0.9em; display: inline-block;">
       –ù–ê –ì–õ–ê–í–ù–£–Æ
    </a>
    <a href="{% url 'core:print_session_bill' session.id %}" class="btn btn-secondary">
    üñ®Ô∏è –ü—Ä–æ–º–µ–∂—É—Ç–æ—á–Ω—ã–π —á–µ–∫
</a>

</div>
    </div>

    <div style="flex: 1; border: 1px solid #ddd; border-radius: 8px; padding: 20px; background: #f9f9f9;">
        <h3 style="margin-top: 0;">–î–æ–±–∞–≤–∏—Ç—å —Å –±–∞—Ä–∞</h3>
        <div style="display: grid; gap: 10px;">
    {% for p in products %}
        <form action="{% url 'core:add_item_to_session' session.id %}" method="post" style="margin: 0;">
            {% csrf_token %}
            <input type="hidden" name="product_id" value="{{ p.id }}">
            <button type="submit" style="width: 100%; text-align: left; padding: 10px; border: 1px solid #ccc; border-radius: 4px; background: white; cursor: pointer; display: flex; justify-content: space-between; transition: background 0.2s;">
                <span>{{ p.name }}</span>
                <strong>{{ p.price }} —Å–æ–º</strong>
            </button>
        </form>
    {% endfor %}
</div>
    </div>
</div>
{% endblock %}